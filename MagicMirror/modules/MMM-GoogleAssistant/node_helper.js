const exec=require("child_process").exec,fs=require("fs"),path=require("path"),Assistant=require("./components/assistant.js"),ScreenParser=require("./components/screenParser.js"),Snowboy=require("@bugsounet/snowboy").Snowboy,Player=require("@bugsounet/native-sound"),npmCheck=require("@bugsounet/npmcheck"),readJson=require("r-json"),Youtube=require("youtube-api");var _log=Function.prototype.bind.call(console.log,console,"[GA]"),log=function(){},NodeHelper=require("node_helper");module.exports=NodeHelper.create({start:function(){this.config={}},socketNotificationReceived:function(e,t){switch(e){case"INIT":console.log("[GA] MMM-GoogleAssistant Version:",require("./package.json").version),this.initialize(t);break;case"ACTIVATE_ASSISTANT":this.activateAssistant(t);break;case"ASSISTANT_BUSY":this.config.snowboy.useSnowboy&&this.snowboy.stop();break;case"ASSISTANT_READY":this.config.snowboy.useSnowboy&&this.snowboy.start();break;case"SHELLEXEC":var i=t.command;i+=t.options?" "+t.options:"",exec(i,(e,o,s)=>{log("ShellExec command:",i),e&&console.log("[GA] ShellExec Error:"+e),this.sendSocketNotification("SHELLEXEC_RESULT",{executed:t,result:{error:e,stdOut:o,stdErr:s}})});break;case"PLAY_AUDIO":this.player.play(t);break;case"PLAY_CHIME":let o=path.resolve(__dirname,t);this.player.play(o,!1);break;case"YouTube_SEARCH":t&&this.YoutubeSearch(t)}},tunnel:function(e){this.sendSocketNotification("TUNNEL",e)},activateAssistant:function(e){log("QUERY:",e);var t=Object.assign({},this.config.assistantConfig);t.debug=this.config.debug,t.lang=e.lang,t.useScreenOutput=e.useScreenOutput,t.useAudioOutput=e.useAudioOutput,t.micConfig=this.config.micConfig,this.assistant=new Assistant(t,e=>{this.tunnel(e)});var i={screenOutputCSS:this.config.responseConfig.screenOutputCSS,screenOutputURI:"tmp/lastScreenOutput.html"},o=new ScreenParser(i,this.config.debug);this.assistant.activate(e,t=>{t.lastQuery=e,t.screen||t.audio||(t.error="NO_RESPONSE",t.transcription&&t.transcription.transcription&&!t.transcription.done&&(t.error="TRANSCRIPTION_FAILS")),"TOO_SHORT"==t.error&&t&&(t.error=null),t.screen?o.parse(t,e=>{delete e.screen.originalContent,log("ASSISTANT_RESULT",e),this.sendSocketNotification("ASSISTANT_RESULT",e)}):(log("ASSISTANT_RESULT",t),this.sendSocketNotification("ASSISTANT_RESULT",t))})},initialize:function(e){this.config=e,this.config.assistantConfig.modulePath=__dirname;var t=null;if(this.config.debug&&(log=_log),fs.existsSync(this.config.assistantConfig.modulePath+"/"+this.config.assistantConfig.credentialPath)?fs.existsSync(this.config.assistantConfig.modulePath+"/"+this.config.assistantConfig.tokenPath)||(t="[ERROR] token.json file not found !"):t="[ERROR] credentials.json file not found !",this.config.A2DServer.useA2D&&this.config.A2DServer.useYouTube)try{const e=readJson(this.config.assistantConfig.modulePath+"/"+this.config.assistantConfig.credentialPath),i=readJson(this.config.assistantConfig.modulePath+"/tokenYT.json");Youtube.authenticate({type:"oauth",client_id:e.installed.client_id,client_secret:e.installed.client_secret,redirect_url:e.installed.redirect_uris,access_token:i.access_token,refresh_token:i.refresh_token});console.log("[GA] YouTube Search Function initilized.")}catch(e){console.log("[GA] "+e),t="[ERROR] YouTube Search not Set !"}if(t)return console.log("[GA]"+t),this.sendSocketNotification("NOT_INITIALIZED",t);if(log("Activate delay is set to "+this.config.responseConfig.activateDelay+" ms"),this.config.snowboy.useSnowboy&&(this.snowboy=new Snowboy(this.config.snowboy,this.config.micConfig,e=>{this.hotwordDetect(e)},this.config.debug),this.snowboy.init()),this.loadRecipes(()=>this.sendSocketNotification("INITIALIZED")),this.config.A2DServer.useA2D&&console.log("[GA] Assistant2Display Server Started"),this.config.responseConfig.useNative&&(this.player=new Player(this.config.responseConfig,e=>{this.sendSocketNotification(e)},this.config.debug),console.log("[GA] Use native program ("+this.config.responseConfig.playProgram+") for audio response"),this.player.init()),this.config.NPMCheck.useChecker){var i={dirName:__dirname,moduleName:this.name,timer:this.config.NPMCheck.delay,debug:this.config.debug};this.Checker=new npmCheck(i,e=>{this.sendSocketNotification("NPM_UPDATE",e)})}console.log("[GA] Google Assistant is initialized.")},loadRecipes:function(e=(()=>{})){if(this.config.recipes){let n=(e,t)=>"function"==typeof t?"__FUNC__"+t.toString():t;for(var t=this.config.recipes,i=null,o=0;o<t.length;o++)try{var s=require("./recipes/"+t[o]).recipe;this.sendSocketNotification("LOAD_RECIPE",JSON.stringify(s,n,2)),console.log("[GA] RECIPE_LOADED:",t[o])}catch(e){return console.log(`[GA] RECIPE_ERROR (${t[o]}):`,e.message,e),i=`[GA] RECIPE_ERROR (${t[o]})`,this.sendSocketNotification("NOT_INITIALIZED",i)}e()}else log("NO_RECIPE_TO_LOAD"),e()},hotwordDetect:function(e){e&&this.sendSocketNotification("ASSISTANT_ACTIVATE",{type:"MIC"})},YoutubeSearch:async function(e){var t=await Youtube.search.list({q:e,part:"snippet",maxResults:1,type:"video"});try{var i=t.data.items[0];console.log("[GA] Found YouTube Title: %s - videoId: %s",i.snippet.title,i.id.videoId),this.sendSocketNotification("YouTube_RESULT",i.id.videoId)}catch(e){console.log("[GA] Youtube Search error or no title found!")}}});
