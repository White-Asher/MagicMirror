const HTMLParser=require("node-html-parser"),path=require("path"),fs=require("fs"),Entities=require("html-entities").AllHtmlEntities,entities=new Entities;var _log=Function.prototype.bind.call(console.log,console,"[GA:SP]"),log=function(){};class SCREENPARSER{constructor(e,t){this.config=e,1==t&&(log=_log)}parse(e,t=(()=>{})){if(e.screen){var r=this.config.screenOutputURI,n=path.resolve(__dirname,"..",r);if(!e.screen.originalContent)return;var o=e.screen.originalContent.toString("utf8");o=(e=>e.replace(/document\.body,"display","none"/gim,e=>'document.body,"display","block"'))(o);var s="/modules/MMM-GoogleAssistant/"+this.config.screenOutputCSS+"?seed="+Date.now();o=o.replace(/<style>html,body[^<]+<\/style>/gim,`<link rel="stylesheet" href="${s}">`);var i=HTMLParser.parse(e.screen.originalContent),l=i.querySelector(".popout-content");l&&(e.screen.text=l.structuredText),e.screen=this.parseScreenLink(e.screen),e.screen.photos=[];var a=i.querySelectorAll(".photo_tv_image");if(a)for(var u=0;u<a.length;u++)e.screen.photos.push(a[u].attributes["data-image-url"]);fs.writeFile(n,o,o=>{o?(log("CONVERSATION:SCREENOUTPUT_CREATION_ERROR",o),t(o)):(log("CONVERSATION:SCREENOUTPUT_CREATED"),e.screen.path=n,e.screen.uri=r,t(e))})}}parseScreenLink(e){var t=e.originalContent;e.links=[];for(var r=[/data-url=\"([^\"]+)\"/gim,/ (http[s]?\:\/\/[^ \)]+)[ ]?\)/gim,/\: (http[s]?\:\/\/[^ <]+)/gim],n=null,o=[],s=0;s<r.length;s++)for(var i=r[s];null!==(n=i.exec(t));)o.push(entities.decode(n[1]));if(0==o.length){var l=new RegExp("http[s]?://m.youtube.com/watch\\?v=([0-9a-zA-Z-_]+)","ig"),a=new RegExp("http[s]?://m.youtube.com/playlist\\?list=([a-zA-Z0-9-_]+)","ig"),u=l.exec(e.text);a.exec(e.text)?(log("YouTube playlist found:",youtubePlayList[0]),o.push(youtubePlayList[0])):u&&(log("YouTube video found:",u[0]),o.push(u[0]))}return e.links=o,e}}module.exports=SCREENPARSER;
